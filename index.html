<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#08090a">
<link rel="manifest" href="/manifest.json">
<title>Unbreakable Workout</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#08090a;--sf:#111214;--cd:#181a1d;--bd:#252830;--bd2:#1e2025;--t1:#f0f0f2;--t2:#a0a4b0;--t3:#6b6f7e;--res:#f97316;--car:#22d3ee;--cor:#a855f7;--spr:#eab308;--grn:#34d399;--grn2:#059669;--blu:#60a5fa;--red:#f87171;--pnk:#e879f9;--amb:#fbbf24;--fn:'DM Sans',system-ui,sans-serif;--mo:'JetBrains Mono',monospace}
body{font-family:var(--fn);background:var(--bg);color:var(--t1);min-height:100vh;overflow-x:hidden}
button{font-family:var(--fn);cursor:pointer}input,textarea,select{font-family:var(--fn)}

/* APP BAR */
.appbar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--sf);border-bottom:1px solid var(--bd2);position:sticky;top:0;z-index:50}
.appbar .logo{display:flex;align-items:center;gap:10px}
.logo-i{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--grn),var(--blu));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;color:#000}
.appbar h1{font-size:16px;font-weight:800;letter-spacing:-.5px}
.appbar .acts{display:flex;gap:8px}
.ab{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--bd);background:var(--cd);color:var(--t2)}
.ab:hover{border-color:#444;color:var(--t1)}.ab.pri{background:linear-gradient(135deg,var(--grn),var(--grn2));border:none;color:#000;font-weight:700}
.builder{display:flex;height:calc(100vh - 53px);overflow:hidden}

/* LIBRARY */
.lib{width:270px;min-width:270px;background:var(--sf);border-right:1px solid var(--bd2);display:flex;flex-direction:column;overflow:hidden}
.lib-hd{padding:12px 14px 10px;border-bottom:1px solid var(--bd2)}
.lib-hd h2{font-size:13px;font-weight:700;margin-bottom:8px;color:var(--t2)}
.lib-sr{width:100%;padding:8px 11px;border-radius:8px;background:var(--cd);border:1px solid var(--bd);color:var(--t1);font-size:12px;outline:none}
.lib-sr:focus{border-color:var(--grn)}
.lib-fl{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
.lf{padding:3px 9px;border-radius:5px;font-size:10px;font-weight:600;border:1px solid var(--bd);background:transparent;color:var(--t3);cursor:pointer}
.lf.on{color:#fff}
.lf[data-c="resistance"].on{background:#f9731620;border-color:var(--res);color:var(--res)}
.lf[data-c="cardio"].on{background:#22d3ee20;border-color:var(--car);color:var(--car)}
.lf[data-c="core"].on{background:#a855f720;border-color:var(--cor);color:var(--cor)}
.lf[data-c="sprints"].on{background:#eab30820;border-color:var(--spr);color:var(--spr)}
.lf[data-c="all"].on{background:rgba(255,255,255,.08);border-color:#555;color:var(--t1)}
.lib-ls{flex:1;overflow-y:auto;padding:6px}
.lcat{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--t3);padding:10px 8px 3px;font-weight:700}
.li{display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;cursor:grab;margin-bottom:1px;border:1px solid transparent;font-size:12px;color:var(--t2)}
.li:hover{background:rgba(255,255,255,.04);color:var(--t1);border-color:var(--bd)}
.li.dragging{opacity:.3}
.ldot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.ltag{font-size:8px;padding:1px 4px;border-radius:3px;font-weight:600;opacity:.6}
.li-x{width:18px;height:18px;border-radius:4px;border:none;background:transparent;color:var(--t3);font-size:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;opacity:0;cursor:pointer}
.li:hover .li-x{opacity:1}.li-x:hover{background:rgba(248,113,113,.15);color:var(--red)}
.lib-add{margin:6px;padding:7px;border-radius:7px;background:var(--cd);border:1px dashed var(--bd);color:var(--t3);font-size:11px;text-align:center;cursor:pointer}
.lib-add:hover{border-color:var(--grn);color:var(--grn)}

/* WORKSPACE */
.ws{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:14px}
.ws-hd{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.sn{font-size:18px;font-weight:800;background:transparent;border:none;color:var(--t1);outline:none;border-bottom:2px solid transparent;padding:2px 0;min-width:180px}
.sn:focus{border-color:var(--grn)}
.ws-m{font-size:11px;color:var(--t3);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.chip{padding:3px 8px;border-radius:5px;background:var(--cd);border:1px solid var(--bd);display:flex;align-items:center;gap:5px;font-size:11px}
.chip button{width:18px;height:18px;border-radius:4px;background:rgba(255,255,255,.05);border:1px solid var(--bd);color:var(--t2);font-size:11px;display:flex;align-items:center;justify-content:center}
.chip .v{font-weight:700;color:var(--amb);font-family:var(--mo);font-size:11px}
.ba{display:flex;gap:12px;flex:1;overflow-x:auto;padding-bottom:10px;align-items:flex-start}

/* BLOCK */
.bcol{width:310px;min-width:310px;background:var(--sf);border:1px solid var(--bd2);border-radius:12px;display:flex;flex-direction:column;max-height:calc(100vh - 160px);overflow:hidden}
.bcol.dov{border-color:var(--grn);box-shadow:0 0 0 1px var(--grn)}
.bch{padding:10px 12px;border-bottom:1px solid var(--bd2);display:flex;align-items:center;gap:6px}
.bnum{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;font-family:var(--mo);flex-shrink:0}
.btit{flex:1;font-size:13px;font-weight:700;background:transparent;border:none;color:var(--t1);outline:none;min-width:0}
.btbadge{font-size:9px;padding:2px 7px;border-radius:4px;font-weight:700;flex-shrink:0}
.bacts{display:flex;gap:3px;flex-shrink:0}
.bab{width:24px;height:24px;border-radius:5px;border:none;background:rgba(255,255,255,.04);color:var(--t3);font-size:11px;display:flex;align-items:center;justify-content:center}
.bab:hover{background:rgba(255,255,255,.08);color:var(--t2)}.bab.del:hover{color:var(--red)}
.btype-r{padding:6px 12px;border-bottom:1px solid var(--bd2);display:flex;gap:6px}
.btype-b{flex:1;padding:5px;border-radius:6px;font-size:10px;font-weight:700;border:1px solid var(--bd);background:transparent;color:var(--t3);text-align:center}
.btype-b.on{border-color:var(--grn);color:var(--grn);background:rgba(52,211,153,.06)}
.bset{padding:8px 12px;border-bottom:1px solid var(--bd2);display:grid;grid-template-columns:1fr 1fr;gap:5px}
.bs{padding:5px 6px;border-radius:7px;background:rgba(255,255,255,.015)}
.bs .l{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:1px;font-weight:600}
.bs .c{display:flex;align-items:center;gap:3px;justify-content:center}
.bs .c button{width:20px;height:20px;border-radius:4px;background:rgba(255,255,255,.05);border:1px solid var(--bd);color:var(--t2);font-size:12px;display:flex;align-items:center;justify-content:center}
.bs .n{font-size:13px;font-weight:700;min-width:28px;text-align:center;font-family:var(--mo)}
.bexs{flex:1;overflow-y:auto;padding:6px;min-height:50px}
.bexs.dt{background:rgba(52,211,153,.02)}

/* EXERCISE IN BLOCK */
.bex{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:8px;margin-bottom:3px;background:var(--cd);border:1px solid var(--bd);cursor:grab}
.bex:hover{border-color:#3a3d48}.bex.dragging{opacity:.2}.bex.dov-ex{border-color:var(--grn);background:rgba(52,211,153,.05)}
.bex-grip{color:#333;font-size:10px;flex-shrink:0}
.bex-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.bex-nm{font-size:12px;font-weight:600;color:var(--t1);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bex-dur{display:flex;align-items:center;gap:2px;flex-shrink:0}
.bex-dur button{width:18px;height:18px;border-radius:4px;background:rgba(255,255,255,.05);border:1px solid var(--bd);color:var(--t2);font-size:10px;display:flex;align-items:center;justify-content:center}
.bex-dur .dv{font-size:11px;font-weight:700;color:var(--grn);min-width:24px;text-align:center;font-family:var(--mo)}
.bex-note{font-size:9px;color:var(--t3);font-style:italic;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bex-acts{display:flex;gap:2px;flex-shrink:0}
.bxb{width:20px;height:20px;border-radius:4px;border:none;background:transparent;color:var(--t3);font-size:10px;display:flex;align-items:center;justify-content:center}
.bxb:hover{background:rgba(255,255,255,.06);color:var(--t2)}.bxb.del:hover{color:var(--red)}
.slbl{position:absolute;top:3px;right:5px;font-size:8px;font-weight:700;color:var(--amb);font-family:var(--mo)}
.dz{padding:14px;text-align:center;color:var(--t3);font-size:11px;border:1px dashed var(--bd);border-radius:7px;margin:3px}
.dz.act{border-color:var(--grn);color:var(--grn)}
.add-bc{width:180px;min-width:180px;display:flex;align-items:center;justify-content:center}
.add-bb{padding:14px 20px;border-radius:12px;background:var(--cd);border:2px dashed var(--bd);color:var(--t3);font-size:13px;font-weight:600;cursor:pointer}
.add-bb:hover{border-color:var(--grn);color:var(--grn)}

/* MODALS */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);z-index:200;display:flex;align-items:center;justify-content:center}
.mdl{background:var(--sf);border:1px solid var(--bd);border-radius:14px;width:92%;max-width:460px;max-height:80vh;overflow-y:auto;padding:20px}
.mdl h2{font-size:16px;font-weight:800;margin-bottom:14px}
.mf{margin-bottom:10px}.mf label{display:block;font-size:11px;color:var(--t3);margin-bottom:3px;font-weight:600}
.mf input,.mf textarea{width:100%;padding:9px 11px;border-radius:7px;background:var(--cd);border:1px solid var(--bd);color:var(--t1);font-size:12px;outline:none}
.mf textarea{resize:vertical;min-height:50px}
.mcats{display:flex;gap:5px;flex-wrap:wrap}
.mcat{padding:5px 10px;border-radius:5px;font-size:11px;font-weight:600;border:1px solid var(--bd);background:transparent;color:var(--t3);cursor:pointer}
.mcat.sel{color:#fff}
.mbtns{display:flex;gap:8px;margin-top:14px}
.mbtns button{flex:1;padding:9px;border-radius:7px;font-size:12px;font-weight:600;border:1px solid var(--bd);background:var(--cd);color:var(--t2);cursor:pointer}
.mbtns button.sv{background:var(--grn);border:none;color:#000;font-weight:700}
.tpl-i{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:9px;background:var(--cd);border:1px solid var(--bd);margin-bottom:6px}
.tpl-i .nm{font-size:13px;font-weight:600}.tpl-i .mt{font-size:10px;color:var(--t3);margin-top:1px}
.tpl-i .tbs{display:flex;gap:5px}
.tpl-i .tbs button{padding:5px 10px;border-radius:5px;font-size:11px;font-weight:600;border:1px solid var(--bd);background:var(--sf);color:var(--t2);cursor:pointer}
.tpl-i .tbs button.dl{color:var(--red)}
.mc{display:block;width:100%;padding:10px;margin-top:10px;border-radius:8px;background:var(--cd);border:1px solid var(--bd);color:var(--t2);font-size:12px;cursor:pointer}
.share-box{padding:12px;border-radius:8px;background:var(--cd);border:1px solid var(--bd);font-family:var(--mo);font-size:10px;color:var(--t2);word-break:break-all;max-height:200px;overflow-y:auto;margin-bottom:10px;user-select:all}
.cpbtn{width:100%;padding:10px;border-radius:8px;background:var(--grn);border:none;color:#000;font-size:13px;font-weight:700;cursor:pointer}

/* MOBILE */
.mob{min-height:100vh;background:var(--bg);padding:16px}
.mob-hd{text-align:center;padding:10px 0 16px}
.mob-hd .tag{font-size:10px;letter-spacing:4px;color:var(--grn);font-weight:700;text-transform:uppercase}
.mob-hd h1{font-size:22px;font-weight:900;margin-top:2px;background:linear-gradient(90deg,var(--grn),var(--blu));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.mob-s{max-width:500px;margin:0 auto}
.mob-sn{font-size:18px;font-weight:800;margin-bottom:4px}
.mob-sm{font-size:12px;color:var(--t3);margin-bottom:16px}
.mob-b{background:var(--sf);border:1px solid var(--bd2);border-radius:12px;margin-bottom:12px;overflow:hidden}
.mob-bh{padding:12px 14px;display:flex;align-items:center;gap:8px;cursor:pointer}
.mob-bn{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;font-family:var(--mo);flex-shrink:0}
.mob-bt{flex:1;font-size:14px;font-weight:700}
.mob-bm{font-size:11px;color:var(--t3)}
.mob-bb{padding:0 14px 12px}
.mob-bi{font-size:11px;color:var(--t3);margin-bottom:8px;line-height:1.5}
.mob-ex{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--bd2)}
.mob-ex:last-child{border:none}
.mob-exn{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
.mob-start{display:block;width:100%;max-width:500px;margin:20px auto;padding:16px;border-radius:14px;background:linear-gradient(135deg,var(--grn),var(--grn2));border:none;color:#000;font-size:17px;font-weight:800;cursor:pointer;box-shadow:0 4px 20px rgba(52,211,153,.3)}
.mob-empty{text-align:center;color:var(--t3);padding:40px 20px;font-size:14px;line-height:1.8}
.mob-ld textarea{width:100%;padding:12px;border-radius:10px;background:var(--cd);border:1px solid var(--bd);color:var(--t1);font-size:12px;font-family:var(--mo);min-height:80px;outline:none;margin-bottom:8px}
.mob-ld button{width:100%;padding:12px;border-radius:10px;background:var(--cd);border:1px solid var(--bd);color:var(--t2);font-size:13px;font-weight:600}
.timer-bar{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#1b4332,#081c15);border-top:2px solid var(--grn);padding:12px 16px;display:flex;align-items:center;gap:12px;z-index:100;cursor:pointer}
.timer-bar .tb-info{flex:1;font-family:var(--mo)}
.timer-bar .tb-phase{font-size:11px;color:var(--grn);text-transform:uppercase;letter-spacing:2px;font-weight:700}
.timer-bar .tb-time{font-size:24px;font-weight:900;color:#fff}
.timer-bar .tb-btn{padding:10px 20px;border-radius:10px;background:var(--grn);border:none;color:#000;font-size:13px;font-weight:700;cursor:pointer}
.mob-ex-edit{cursor:pointer;position:relative}
.mob-ex-edit:active{background:rgba(255,255,255,.04);border-radius:8px}
.mob-ex-acts{display:flex;gap:6px;margin-left:auto;flex-shrink:0}
.mob-ex-acts button{width:28px;height:28px;border-radius:6px;border:1px solid var(--bd);background:var(--cd);color:var(--t2);font-size:12px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.mob-ex-acts button:active{background:rgba(255,255,255,.08)}
.mob-ex-acts button.del{color:var(--red)}
.mob-play{width:32px;height:32px;border-radius:8px;border:1px solid var(--grn);background:rgba(52,211,153,.08);color:var(--grn);font-size:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.mob-play:active{background:rgba(52,211,153,.2)}
.swap-list{max-height:50vh;overflow-y:auto;margin:8px 0}
.swap-item{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;cursor:pointer;border:1px solid transparent;margin-bottom:2px}
.swap-item:active,.swap-item:hover{background:rgba(255,255,255,.04);border-color:var(--bd)}
.swap-sr{width:100%;padding:9px 11px;border-radius:8px;background:var(--cd);border:1px solid var(--bd);color:var(--t1);font-size:13px;outline:none;margin-bottom:8px}
.swap-sr:focus{border-color:var(--grn)}

/* TIMER */
.timer{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;transition:background .5s;position:fixed;inset:0;z-index:300;user-select:none;font-family:var(--mo)}
.t-rdy{background:linear-gradient(135deg,#1a1a2e,#16213e)}
.t-wrk{background:linear-gradient(135deg,#1b4332,#081c15)}
.t-rst{background:linear-gradient(135deg,#1a1a2e,#0d1b2a)}
.t-trn{background:linear-gradient(135deg,#2a1a0a,#1a0f05)}
.t-dn{background:linear-gradient(135deg,#2d1b4e,#1a0a2e)}
.tbar{position:absolute;top:0;left:0;right:0;height:4px;background:rgba(255,255,255,.08)}
.tfill{height:100%;transition:width .3s linear}
.bdots{position:absolute;top:14px;display:flex;gap:6px}
.bdt{width:8px;height:8px;border-radius:4px;background:rgba(255,255,255,.1)}
.bdt.act{width:24px}.bdt.dn{background:rgba(255,255,255,.25)}
.tph{font-size:clamp(16px,4vw,22px);letter-spacing:8px;text-transform:uppercase;font-weight:700}
.tblk{font-size:12px;color:rgba(255,255,255,.3);margin-bottom:2px;font-family:var(--fn)}
.tex{font-size:clamp(26px,8vw,52px);font-weight:800;text-align:center;line-height:1.1;color:#fff;margin:6px 0;font-family:var(--fn)}
.texn{font-size:12px;color:rgba(255,255,255,.3);margin-top:2px;font-style:italic;font-family:var(--fn)}
.tbig{font-size:clamp(120px,42vw,240px);font-weight:900;line-height:1;font-variant-numeric:tabular-nums;margin:6px 0}
.countdown-flash{animation:cdPulse .6s ease-out;position:relative}
.cd-2{color:#f97316 !important;text-shadow:0 0 80px rgba(249,115,22,.6) !important}
.cd-1{color:#ef4444 !important;text-shadow:0 0 100px rgba(239,68,68,.8) !important;animation:cdPulse .6s ease-out,cdShake .1s ease-in-out 3}
@keyframes cdPulse{0%{transform:scale(1.8);opacity:0}30%{opacity:1}100%{transform:scale(1);opacity:1}}
@keyframes cdShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.ttrk{width:180px;height:4px;border-radius:2px;background:rgba(255,255,255,.08);margin-bottom:12px}
.ttf{height:100%;border-radius:2px;transition:width .3s linear}
.tmeta{display:flex;gap:16px;font-size:12px;color:rgba(255,255,255,.3);flex-wrap:wrap;justify-content:center}
.tmeta strong{font-weight:700}
.thint{margin-top:10px;padding:8px 20px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);font-size:12px;color:rgba(255,255,255,.35);font-family:var(--fn)}
.rot-flash{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(40px,14vw,90px);font-weight:900;color:#fbbf24;text-shadow:0 0 60px rgba(251,191,36,.5);z-index:310;pointer-events:none;animation:rotIn .3s ease-out,rotOut .5s ease-in 1.2s forwards;font-family:var(--fn)}
@keyframes rotIn{0%{transform:translate(-50%,-50%) scale(2.5);opacity:0}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
@keyframes rotOut{0%{opacity:1}100%{opacity:0}}
.thint strong{color:#fff}
.rotinf{font-size:14px;color:rgba(255,255,255,.5);margin-top:6px;font-family:var(--fn)}
.rotinf strong{color:#fff}
.tctrl{display:flex;gap:12px;margin-top:24px}
.tb{width:54px;height:54px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.12);background:rgba(255,255,255,.07);color:#fff}
.tb:active{transform:scale(.94)}.tb.stp{background:rgba(248,113,113,.1);border-color:rgba(248,113,113,.2);color:var(--red)}.tb.sk{font-size:15px}
.pov{position:absolute;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10}
.pov .pt{font-size:40px;font-weight:800;color:var(--amb);margin-bottom:16px}
.pov button{padding:14px 44px;border-radius:14px;background:linear-gradient(135deg,var(--grn),var(--grn2));border:none;color:#000;font-size:16px;font-weight:700;cursor:pointer;font-family:var(--fn)}
.trs{text-align:center;font-family:var(--fn)}.trs .un{font-size:12px;letter-spacing:4px;color:var(--amb);text-transform:uppercase;margin-bottom:6px}.trs .bn{font-size:28px;font-weight:800;color:#fff;margin-bottom:4px}.trs .bd2{font-size:12px;color:rgba(255,255,255,.3);line-height:1.6}.trs .ep{margin-top:8px;font-size:11px;color:rgba(255,255,255,.2);line-height:1.8}.trs .ep strong{color:rgba(255,255,255,.45)}
.tdn{text-align:center;font-family:var(--fn)}.tdn .emoji{font-size:60px;margin-bottom:8px}.tdn .title{font-size:36px;font-weight:800;margin-bottom:6px}.tdn .sub{font-size:13px;color:rgba(255,255,255,.3);margin-bottom:28px}
.tdn button{padding:12px 32px;border-radius:14px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);color:#fff;font-size:14px;font-weight:600;cursor:pointer;font-family:var(--fn)}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#2a2d35;border-radius:3px}
</style>
</head>
<body>
<div id="app"></div>
<script>
const CATS={resistance:{label:'Resistance',color:'#f97316',s:'RES'},cardio:{label:'Cardio',color:'#22d3ee',s:'CAR'},core:{label:'Core',color:'#a855f7',s:'COR'},sprints:{label:'Sprints',color:'#eab308',s:'SPR'}};
const BCOLS=['#34d399','#60a5fa','#e879f9','#fbbf24','#f87171','#06d6a0','#8b5cf6','#fb923c'];
const DEF_LIB=[
{name:"Push-Ups",cats:["resistance"]},{name:"Diamond Push-Ups",cats:["resistance"]},{name:"Wide Push-Ups",cats:["resistance"]},{name:"Pike Push-Ups",cats:["resistance"]},{name:"Tricep Dips",cats:["resistance"]},{name:"Plank Up-Downs",cats:["resistance","core"]},{name:"Bear Crawl",cats:["resistance","cardio"]},{name:"Burpees",cats:["resistance","cardio"]},{name:"Commando Push-Ups",cats:["resistance","core"]},{name:"Superman Hold",cats:["resistance","core"]},{name:"Inchworms",cats:["resistance","cardio"]},{name:"Tricep Extensions",cats:["resistance"]},{name:"Banded Rows",cats:["resistance"]},{name:"Shoulder Press",cats:["resistance"]},{name:"Bicep Curls",cats:["resistance"]},{name:"Kettlebell Swings",cats:["resistance","cardio"]},{name:"Dumbbell Rows",cats:["resistance"]},{name:"Overhead Press",cats:["resistance"]},{name:"Deadlifts",cats:["resistance"]},
{name:"Jump Squats",cats:["resistance","cardio"]},{name:"Lunges",cats:["resistance"]},{name:"Reverse Lunges",cats:["resistance"]},{name:"Squat Pulses",cats:["resistance"]},{name:"Sumo Squats",cats:["resistance"]},{name:"Wall Sit",cats:["resistance"]},{name:"Glute Bridges",cats:["resistance"]},{name:"Split Squats",cats:["resistance"]},{name:"Step-Ups",cats:["resistance","cardio"]},{name:"Box Jumps",cats:["resistance","sprints"]},{name:"Jump Lunges",cats:["resistance","cardio"]},{name:"Lateral Lunges",cats:["resistance","sprints"]},{name:"Calf Raises",cats:["resistance"]},{name:"Single Leg Deadlift",cats:["resistance"]},{name:"A2C Squat Jumps",cats:["resistance","cardio"]},{name:"Step Jumps",cats:["cardio","sprints"]},
{name:"High Knees",cats:["cardio"]},{name:"Butt Kicks",cats:["cardio"]},{name:"Star Jumps",cats:["cardio"]},{name:"Jumping Jacks",cats:["cardio"]},{name:"Fast Feet",cats:["cardio","sprints"]},{name:"Sprint in Place",cats:["cardio","sprints"]},{name:"Mountain Climbers",cats:["cardio","core"]},{name:"Squat Thrusts",cats:["cardio"]},{name:"Seal Jacks",cats:["cardio"]},{name:"Skaters",cats:["cardio","sprints"]},{name:"Frog Jumps",cats:["cardio","sprints"]},{name:"Ice Skaters",cats:["cardio","sprints"]},{name:"Tuck Jumps",cats:["cardio","sprints"]},{name:"Power Skips",cats:["cardio","sprints"]},{name:"Battle Ropes",cats:["cardio","resistance"]},
{name:"Plank Hold",cats:["core"]},{name:"Bicycle Crunches",cats:["core"]},{name:"Russian Twists",cats:["core"]},{name:"Leg Raises",cats:["core"]},{name:"Dead Bugs",cats:["core"]},{name:"V-Ups",cats:["core"]},{name:"Flutter Kicks",cats:["core"]},{name:"Hollow Hold",cats:["core"]},{name:"Side Plank (L)",cats:["core"]},{name:"Side Plank (R)",cats:["core"]},{name:"Plank Jacks",cats:["core","cardio"]},{name:"Reverse Crunches",cats:["core"]},{name:"Toe Touches",cats:["core"]},{name:"Windshield Wipers",cats:["core"]},{name:"Bicycles",cats:["core"]},
{name:"Shuttle Runs",cats:["sprints"]},{name:"Suicide Drills",cats:["sprints"]},{name:"Lateral Shuffles",cats:["sprints"]},{name:"Broad Jumps",cats:["sprints"]},{name:"Agility Ladder",cats:["sprints"]},{name:"Cone Drills",cats:["sprints"]},{name:"Sprint Intervals",cats:["sprints","cardio"]},{name:"High Knee Sprints",cats:["sprints","cardio"]},{name:"Bounding",cats:["sprints"]},{name:"T-Drill",cats:["sprints"]},{name:"Hill Sprints",cats:["sprints","cardio"]},{name:"Sled Push",cats:["sprints","resistance"]}
];
let lib=JSON.parse(localStorage.getItem('hp2_lib'))||DEF_LIB.map(e=>({...e,note:''}));
let libDel=JSON.parse(localStorage.getItem('hp2_libdel'))||[];
{const ns=new Set(lib.map(e=>e.name));const ds=new Set(libDel);DEF_LIB.forEach(e=>{if(!ns.has(e.name)&&!ds.has(e.name))lib.push({...e,note:''})});}
function saveLib(){localStorage.setItem('hp2_lib',JSON.stringify(lib));localStorage.setItem('hp2_libdel',JSON.stringify(libDel));fetch('/api/library',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lib,del:libDel})}).catch(()=>{})}
let tpls=JSON.parse(localStorage.getItem('hp2_tpls'))||[];
function saveTpls(){localStorage.setItem('hp2_tpls',JSON.stringify(tpls));fetch('/api/templates',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(tpls)}).catch(()=>{})}
function saveSession(){const d={n:S.sName,blocks:S.blocks};fetch('/api/session',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).catch(()=>{})}
// Load from server on startup
async function loadFromServer(){
  try{
    const[libR,tplR,sessR]=await Promise.all([fetch('/api/library').then(r=>r.json()).catch(()=>null),fetch('/api/templates').then(r=>r.json()).catch(()=>null),fetch('/api/session').then(r=>r.json()).catch(()=>null)]);
    if(libR){
      if(Array.isArray(libR)){lib=libR}
      else if(libR.lib){lib=libR.lib;libDel=libR.del||[]}
      const ns=new Set(lib.map(e=>e.name));const ds=new Set(libDel);DEF_LIB.forEach(e=>{if(!ns.has(e.name)&&!ds.has(e.name))lib.push({...e,note:''})});
      localStorage.setItem('hp2_lib',JSON.stringify(lib));localStorage.setItem('hp2_libdel',JSON.stringify(libDel));
    }
    if(tplR&&Array.isArray(tplR)){tpls=tplR;localStorage.setItem('hp2_tpls',JSON.stringify(tpls))}
    if(sessR&&sessR.blocks){if(isMob){S.mobSession=sessR;S.blocks=sessR.blocks;S.sName=sessR.n||'Session'}else{S.blocks=sessR.blocks;S.sName=sessR.n||'Session'}}
    render();
  }catch(e){console.log('Server load failed, using local data')}
}

const isMob=window.innerWidth<768||/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
function uid(){return Math.random().toString(36).slice(2,8)}
function bcol(i){return BCOLS[i%BCOLS.length]}
function pcc(c){return CATS[c?.[0]]?.color||'#666'}
function ctag(c){const C=CATS[c];return C?`<span class="ltag" style="background:${C.color}18;color:${C.color}">${C.s}</span>`:''}
function fmts(s){if(s<0)s=0;const m=Math.floor(s/60),sc=s%60;return m>0?m+':'+String(sc).padStart(2,'0'):String(sc)}
function fmtd(s){const m=Math.floor(s/60),sc=s%60;return m+'m'+(sc?sc+'s':'')}

/*
  Exercise in block: {name, cats, note, duration} 
  duration defaults to block workTime but can be overridden per exercise
*/
function newBlock(i,type='hiit'){
  return{id:uid(),name:'Block '+(i+1),type,
    workTime:30,        // default duration per exercise
    restBetween:0,      // rest between exercises (HIIT only)
    restAfterRound:30,  // rest after completing all exercises / rotation
    restAfterBlock:30,  // rest before next block starts
    rounds:5,
    exPerStation:3,     // stations only: exercises per station
    exercises:[]        // {name, cats, note, duration}
  }
}

// ‚ïê‚ïê‚ïê Duration calc ‚ïê‚ïê‚ïê
function blockDur(b){
  if(b.type==='stations'){
    const n=b.exPerStation||3;
    const perRound=n*b.workTime+b.restAfterRound;
    return perRound*b.rounds;
  }
  // HIIT: use per-exercise durations
  if(!b.exercises.length)return 0;
  const exTime=b.exercises.reduce((s,e)=>s+(e.duration||b.workTime),0);
  const restBtw=Math.max(0,b.exercises.length-1)*b.restBetween;
  const perRound=exTime+restBtw+b.restAfterRound;
  return perRound*b.rounds;
}
function totalDur(blks){
  const bb=blks||S.blocks;
  let t=5;// get ready
  bb.forEach(b=>{t+=blockDur(b)+(b.restAfterBlock||0)});
  return t;
}

// ‚ïê‚ïê‚ïê State ‚ïê‚ïê‚ïê
let S={screen:isMob?'mobile':'builder',sName:'New Session',targetTime:45,blocks:[],
  libSearch:'',libFilter:'all',modal:null,noteBI:-1,noteEI:-1,
  ceData:{name:'',cats:[],note:''},
  phase:'',bI:0,eI:0,rI:0,tL:0,paused:false,soundMode:'all',timerRunning:false,
  mobEdit:null,mobEditMode:false,
  mobSession:null,mobC:{}};

function loadHash(){
  if(location.hash.length>1){try{const d=JSON.parse(decodeURIComponent(atob(location.hash.slice(1))));if(d.blocks){S.sName=d.n||'Session';S.blocks=d.blocks;if(isMob)S.mobSession=d;return true}}catch(e){}}return false;
}
if(!loadHash())S.blocks=[newBlock(0)];

// ‚ïê‚ïê‚ïê Audio ‚ïê‚ïê‚ïê
let actx=null;function ga(){if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)();return actx}
function bip(f,d,t='sine'){try{const c=ga(),o=c.createOscillator(),g=c.createGain();o.type=t;o.frequency.value=f;g.gain.value=.5;g.gain.exponentialRampToValueAtTime(.01,c.currentTime+d);o.connect(g);g.connect(c.destination);o.start(c.currentTime);o.stop(c.currentTime+d)}catch(e){}}
const _sn={tick:()=>bip(880,.1),go:()=>{bip(1100,.2,'square');setTimeout(()=>bip(1400,.3,'square'),250)},rest:()=>bip(440,.3,'triangle'),done:()=>{bip(880,.12);setTimeout(()=>bip(1100,.12),160);setTimeout(()=>bip(1400,.12),320);setTimeout(()=>bip(1760,.35),480)},rotate:()=>{bip(1000,.15,'square');setTimeout(()=>bip(1200,.15,'square'),170);setTimeout(()=>bip(1000,.15,'square'),340)}};
const sn={
  tick:()=>{if(S.soundMode==='all')_sn.tick()},
  go:()=>{if(S.soundMode==='all')_sn.go()},
  rest:()=>{if(S.soundMode==='all')_sn.rest()},
  done:()=>{if(S.soundMode!=='mute')_sn.done()},
  rotate:()=>{if(S.soundMode==='all')_sn.rotate()}
};

// ‚ïê‚ïê‚ïê Timer ‚ïê‚ïê‚ïê
let tInt=null;
function curBlocks(){return S.mobSession?.blocks||S.blocks}
function startTimer(){
  const blks=curBlocks();
  if(!blks.some(b=>b.type==='stations'||b.exercises.length))return;
  ga();S.screen='timer';S.bI=0;S.eI=0;S.rI=0;S.paused=false;S.phase='ready';S.tL=5;S.timerRunning=true;
  clearInterval(tInt);tInt=setInterval(tick,1e3);
  try{navigator.wakeLock?.request('screen')}catch(e){}render();
}
function tick(){if(S.paused)return;S.tL--;if(S.tL>0&&S.tL<=3)sn.tick();if(S.tL<=0)advance();
  if(S.screen==='mobile'&&S.timerRunning){
    const tb=document.querySelector('.tb-time');if(tb)tb.textContent=fmts(S.tL);
    const tp=document.querySelector('.tb-phase');if(tp)tp.textContent=S.phase;
  }else render();
}

function advance(){
  const blks=curBlocks(),b=blks[S.bI];
  if(!b){finish();return}
  const isSt=b.type==='stations';
  const tot=isSt?(b.exPerStation||3):b.exercises.length;

  if(S.phase==='ready'){sn.go();S.phase='work';S.eI=0;S.tL=isSt?b.workTime:(b.exercises[0]?.duration||b.workTime);return}
  if(S.phase==='blockRest'){
    const nb=blks[S.bI];if(!nb){finish();return}
    sn.go();S.eI=0;S.rI=0;
    const nisSt=nb.type==='stations';
    S.phase='work';S.tL=nisSt?nb.workTime:(nb.exercises[0]?.duration||nb.workTime);return;
  }
  if(S.phase==='work'){
    const nx=S.eI+1;
    if(nx>=tot){
      // End of round
      const nR=S.rI+1;
      if(nR>=b.rounds){
        // End of block
        const nB=S.bI+1;
        if(nB>=blks.length){finish();return}
        S.bI=nB;
        const restAB=b.restAfterBlock||0;
        if(restAB>0){isSt?sn.rotate():sn.rest();S.phase='blockRest';S.tL=restAB}
        else{sn.go();S.eI=0;S.rI=0;const nb2=blks[S.bI];S.phase='work';S.tL=nb2.type==='stations'?nb2.workTime:(nb2.exercises[0]?.duration||nb2.workTime)}
        return;
      }
      isSt?sn.rotate():sn.rest();S.rI=nR;S.eI=0;
      if(b.restAfterRound>0){S.phase='roundRest';S.tL=b.restAfterRound}
      else{sn.go();S.phase='work';S.tL=isSt?b.workTime:(b.exercises[0]?.duration||b.workTime)}
      return;
    }
    S.eI=nx;
    if(!isSt&&b.restBetween>0){sn.rest();S.phase='rest';S.tL=b.restBetween}
    else{sn.go();if(isSt)showRotateFlash();S.phase='work';S.tL=isSt?b.workTime:(b.exercises[nx]?.duration||b.workTime)}
    return;
  }
  if(S.phase==='rest'){
    const b2=curBlocks()[S.bI];sn.go();S.phase='work';S.tL=b2.exercises[S.eI]?.duration||b2.workTime;return;
  }
  if(S.phase==='roundRest'){
    const b2=curBlocks()[S.bI];const isSt2=b2.type==='stations';
    sn.go();S.phase='work';S.tL=isSt2?b2.workTime:(b2.exercises[0]?.duration||b2.workTime);return;
  }
}
function finish(){sn.done();S.phase='done';S.tL=0;S.timerRunning=false;clearInterval(tInt);tInt=null;if(S.screen==='mobile')render();else{S.screen=isMob?'mobile':'builder';render()}}
function stopT(){clearInterval(tInt);tInt=null;S.screen=isMob?'mobile':'builder';S.phase='';S.paused=false;S.timerRunning=false;render()}
function togPause(){S.paused=!S.paused;render()}
function minimizeT(){S.screen='mobile';S.timerRunning=true;render()}
function returnToT(){S.screen='timer';render()}
function skip(){S.tL=0;advance();render()}
function showRotateFlash(){
  const el=document.createElement('div');el.className='rot-flash';el.textContent='üîÑ ROTATE!';
  document.body.appendChild(el);setTimeout(()=>el.remove(),1800);
}

// ‚ïê‚ïê‚ïê Share ‚ïê‚ïê‚ïê
function genShareURL(){return location.origin+location.pathname+'#'+btoa(encodeURIComponent(JSON.stringify({n:S.sName,blocks:S.blocks})))}

// ‚ïê‚ïê‚ïê Drag ‚ïê‚ïê‚ïê
let drag={type:null,data:null};

// ‚ïê‚ïê‚ïê Render ‚ïê‚ïê‚ïê
let _saveTimer=null;
function autoSave(){clearTimeout(_saveTimer);_saveTimer=setTimeout(()=>saveSession(),1500)}
function render(){
  const app=document.getElementById('app');
  if(S.screen==='timer'){app.innerHTML=rTimer();bTimer();return}
  if(S.screen==='mobile'){app.innerHTML=rMobile();bMobile();return}
  app.innerHTML=rBuilder();bBuilder();
  autoSave();
}

// ‚îÄ‚îÄ‚îÄ Builder ‚îÄ‚îÄ‚îÄ
function filtLib(){let i=lib;if(S.libFilter!=='all')i=i.filter(e=>e.cats.includes(S.libFilter));if(S.libSearch){const s=S.libSearch.toLowerCase();i=i.filter(e=>e.name.toLowerCase().includes(s))}return i}

function rBuilder(){
  const items=filtLib();const grouped={};
  items.forEach(e=>{const p=e.cats[0]||'other';if(!grouped[p])grouped[p]=[];grouped[p].push(e)});
  let lhtml='';
  for(const[cat,exs]of Object.entries(grouped)){const C=CATS[cat];lhtml+=`<div class="lcat" style="color:${C?.color||'#666'}">${C?.label||cat}</div>`;
    exs.forEach(e=>{const tags=e.cats.map(c=>ctag(c)).join('');lhtml+=`<div class="li" draggable="true" data-lib="${e.name}"><span class="ldot" style="background:${pcc(e.cats)}"></span><span style="flex:1">${e.name}</span>${tags}<button class="li-x" data-ldel="${e.name}">‚úï</button></div>`});
  }
  const filters=['all','resistance','cardio','core','sprints'].map(c=>`<button class="lf ${S.libFilter===c?'on':''}" data-c="${c}">${c==='all'?'All':CATS[c].label}</button>`).join('');

  const blksHtml=S.blocks.map((b,bi)=>{
    const col=bcol(bi),isSt=b.type==='stations';
    const exHtml=b.exercises.map((ex,ei)=>{
      const le=lib.find(l=>l.name===ex.name);const dur=ex.duration||b.workTime;
      return`<div class="bex" draggable="true" data-bi="${bi}" data-ei="${ei}"><span class="bex-grip">‚†ø</span><span class="bex-dot" style="background:${pcc(le?.cats||ex.cats)}"></span><span class="bex-nm">${ex.name}</span>
        <div class="bex-dur"><button data-ed="${bi}" data-ee="${ei}" data-d="-1">‚àí</button><span class="dv">${dur}s</span><button data-ed="${bi}" data-ee="${ei}" data-d="1">+</button></div>
        <div class="bex-acts"><button class="bxb" data-act="note" data-bi="${bi}" data-ei="${ei}">üìù</button><button class="bxb" data-act="dup" data-bi="${bi}" data-ei="${ei}">‚ßâ</button><button class="bxb del" data-act="del" data-bi="${bi}" data-ei="${ei}">‚úï</button></div></div>`;
    }).join('');
    const dz=b.exercises.length===0?`<div class="dz" data-dbi="${bi}">Drag exercises here</div>`:'';

    let topSet,botSet;
    const restRound=`<div class="bs"><div class="l">Rest / ${isSt?'Rotation':'Round'}</div><div class="c"><button data-bs="restAfterRound" data-bi="${bi}" data-d="-1">‚àí</button><span class="n" style="color:var(--amb)">${b.restAfterRound}s</span><button data-bs="restAfterRound" data-bi="${bi}" data-d="1">+</button></div></div>`;
    const restBlock=`<div class="bs"><div class="l">Rest After Block</div><div class="c"><button data-bs="restAfterBlock" data-bi="${bi}" data-d="-1">‚àí</button><span class="n" style="color:var(--red)">${b.restAfterBlock||0}s</span><button data-bs="restAfterBlock" data-bi="${bi}" data-d="1">+</button></div></div>`;
    botSet=`<div class="bset" style="border-top:1px solid var(--bd2);border-bottom:none">${restRound}${restBlock}</div>`;
    if(isSt){
      topSet=`<div class="bset"><div class="bs"><div class="l">Ex / Station</div><div class="c"><button data-bs="exPerStation" data-bi="${bi}" data-d="-1">‚àí</button><span class="n" style="color:var(--car)">${b.exPerStation||3}</span><button data-bs="exPerStation" data-bi="${bi}" data-d="1">+</button></div></div><div class="bs"><div class="l">Work / Exercise</div><div class="c"><button data-bs="workTime" data-bi="${bi}" data-d="-1">‚àí</button><span class="n" style="color:var(--grn)">${b.workTime}s</span><button data-bs="workTime" data-bi="${bi}" data-d="1">+</button></div></div><div class="bs"><div class="l">Rotations</div><div class="c"><button data-bs="rounds" data-bi="${bi}" data-d="-1">‚àí</button><span class="n" style="color:var(--pnk)">${b.rounds}</span><button data-bs="rounds" data-bi="${bi}" data-d="1">+</button></div></div></div>`;
    }else{
      topSet=`<div class="bset"><div class="bs"><div class="l">Default Work</div><div class="c"><button data-bs="workTime" data-bi="${bi}" data-d="-1">‚àí</button><span class="n" style="color:var(--grn)">${b.workTime}s</span><button data-bs="workTime" data-bi="${bi}" data-d="1">+</button></div></div><div class="bs"><div class="l">Rest Between</div><div class="c"><button data-bs="restBetween" data-bi="${bi}" data-d="-1">‚àí</button><span class="n" style="color:var(--blu)">${b.restBetween}s</span><button data-bs="restBetween" data-bi="${bi}" data-d="1">+</button></div></div><div class="bs"><div class="l">Rounds</div><div class="c"><button data-bs="rounds" data-bi="${bi}" data-d="-1">‚àí</button><span class="n" style="color:var(--pnk)">${b.rounds}</span><button data-bs="rounds" data-bi="${bi}" data-d="1">+</button></div></div></div>`;
    }
    const badge=isSt?`<span class="btbadge" style="background:#eab30820;color:var(--spr)">STATIONS</span>`:`<span class="btbadge" style="background:#22d3ee20;color:var(--car)">HIIT</span>`;
    const dur=blockDur(b)+(b.restAfterBlock||0);

    return`<div class="bcol" data-bci="${bi}"><div class="bch" style="flex-wrap:wrap"><div style="display:flex;align-items:center;gap:6px;width:100%"><span class="bnum" style="background:${col}20;color:${col}">${bi+1}</span>${badge}<span style="font-size:10px;color:var(--t3);margin-left:auto">${fmtd(dur)}</span><div class="bacts">${bi>0?`<button class="bab" data-mv="${bi}" data-d="-1">‚Üê</button>`:''}${bi<S.blocks.length-1?`<button class="bab" data-mv="${bi}" data-d="1">‚Üí</button>`:''}<button class="bab del" data-db="${bi}">‚úï</button><button class="bab" data-cloneb="${bi}" title="Clone block">‚ßâ</button></div></div><input class="btit" value="${b.name}" data-bn="${bi}" style="width:100%;margin-top:4px"></div>
    <div class="btype-r"><button class="btype-b ${!isSt?'on':''}" data-bt="${bi}" data-v="hiit">HIIT</button><button class="btype-b ${isSt?'on':''}" data-bt="${bi}" data-v="stations">Stations</button></div>
    ${topSet}<div class="bexs" data-dbi="${bi}">${exHtml}${dz}</div>${botSet}</div>`;
  }).join('');

  const td=totalDur();
  const targetSec=S.targetTime*60;
  const remaining=targetSec-td;
  const remAbs=Math.abs(remaining);
  const remStr=remaining>=0?`${fmtd(remAbs)} spare`:`${fmtd(remAbs)} over`;
  const remCol=remaining>=0?(remaining<120?'var(--amb)':'var(--grn)'):'var(--red)';
  let mdl='';
  if(S.modal==='templates')mdl=rTplModal();
  if(S.modal==='customEx')mdl=rCeModal();
  if(S.modal==='note')mdl=rNoteModal();
  if(S.modal==='share')mdl=rShareModal();

  return`<div class="appbar"><div class="logo"><div class="logo-i">U</div><h1>Unbreakable Workout</h1></div><div class="acts"><button class="ab" id="btn-tpl">üìÅ Templates</button><button class="ab" id="btn-save">üíæ Save</button><button class="ab" id="btn-share">üì± Share</button><button class="ab pri" id="btn-start">‚ñ∂ Start</button></div></div>
  <div class="builder"><div class="lib"><div class="lib-hd"><h2>Exercise Library</h2><input class="lib-sr" id="lsr" placeholder="Search..." value="${S.libSearch}"><div class="lib-fl">${filters}</div></div><div class="lib-ls" id="lls">${lhtml}</div><div class="lib-add" id="btn-ce">+ Custom Exercise</div></div>
  <div class="ws"><div class="ws-hd"><input class="sn" id="sn" value="${S.sName}"><div class="ws-m"><div class="chip">üéØ<button data-tt="-1">‚àí</button><span class="v">${S.targetTime}m</span><button data-tt="1">+</button></div><span style="color:var(--t3)">Built: <strong style="color:var(--amb)">${fmtd(td)}</strong></span><span style="color:${remCol};font-weight:700">${remStr}</span></div></div>
  <div class="ba" id="ba">${blksHtml}<div class="add-bc"><button class="add-bb" id="btn-ab">+ Block</button></div></div></div></div>${mdl}`;
}

// ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ
function rTplModal(){let l='';if(!tpls.length)l='<div style="text-align:center;color:var(--t3);padding:16px;font-size:12px">No saved templates</div>';else tpls.forEach((t,i)=>{l+=`<div class="tpl-i"><div><div class="nm">${t.name}</div><div class="mt">${t.blocks?.length||0} blocks</div></div><div class="tbs"><button data-tl="${i}">Load</button><button class="dl" data-td="${i}">Del</button></div></div>`});return`<div class="mbg" id="mbg"><div class="mdl"><h2>Templates</h2>${l}<button class="mc" id="mclose">Close</button></div></div>`}
function rCeModal(){const cb=Object.entries(CATS).map(([k,v])=>`<button class="mcat ${S.ceData.cats.includes(k)?'sel':''}" data-cc="${k}" style="${S.ceData.cats.includes(k)?`background:${v.color}20;border-color:${v.color};color:${v.color}`:''}">${v.label}</button>`).join('');return`<div class="mbg" id="mbg"><div class="mdl"><h2>Custom Exercise</h2><div class="mf"><label>Name</label><input id="cen" value="${S.ceData.name}"></div><div class="mf"><label>Categories</label><div class="mcats">${cb}</div></div><div class="mf"><label>Notes</label><textarea id="cent">${S.ceData.note||''}</textarea></div><div class="mbtns"><button id="cec">Cancel</button><button class="sv" id="ces">Add</button></div></div></div>`}
function rNoteModal(){const ex=S.blocks[S.noteBI]?.exercises[S.noteEI];return`<div class="mbg" id="mbg"><div class="mdl"><h2>Note: ${ex?.name||''}</h2><div class="mf"><textarea id="ntext">${ex?.note||''}</textarea></div><div class="mbtns"><button id="nc">Cancel</button><button class="sv" id="ns">Save</button></div></div></div>`}
function rShareModal(){const url=genShareURL();const siteUrl=location.origin+location.pathname;const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(siteUrl)}`;return`<div class="mbg" id="mbg"><div class="mdl"><h2>üì± Sync to Mobile</h2><p style="font-size:12px;color:var(--t3);margin-bottom:12px">Scan this QR code on your phone to open the workout timer:</p><div style="text-align:center;margin:16px 0"><img id="qrc" src="${qrUrl}" width="200" height="200" style="border-radius:8px;background:#fff" onerror="this.style.display='none'"><div id="qrf" style="display:none;color:var(--t3);font-size:12px;padding:16px">QR loading failed ‚Äî copy the URL below instead</div></div><p style="font-size:12px;color:var(--amb);font-weight:700;text-align:center;margin-bottom:12px;word-break:break-all">${siteUrl}</p><button class="cpbtn" id="cpurl" style="margin-bottom:8px">üìã Copy Site URL</button><p style="font-size:11px;color:var(--t3);margin-top:12px">Or share via encoded URL (works offline):</p><div class="share-box" id="surl" style="margin-top:6px">${url}</div><button class="cpbtn" id="cpurl2" style="background:var(--cd);color:var(--t2);border:1px solid var(--bd);margin-top:6px">üìã Copy Workout URL</button><button class="mc" id="mclose">Close</button></div></div>`}

// ‚îÄ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ‚îÄ
function rMobile(){
  const sess=S.mobSession||{n:S.sName,blocks:S.blocks};
  const blks=sess.blocks||S.blocks;
  const has=blks?.some(b=>b.type==='stations'||b.exercises?.length);
  if(!has&&!S.timerRunning)return`<div class="mob"><div class="mob-hd"><div class="tag">Unbreakable Workout</div><h1>Workout Timer</h1></div><div class="mob-empty">No workout loaded.<br><br>Build on desktop ‚Üí Share to Mobile<br><br>Or paste data:</div><div class="mob-ld" style="max-width:500px;margin:0 auto"><textarea id="mpaste" placeholder="Paste session data..."></textarea><button id="mload">Load</button></div></div>`;
  const td=totalDur(blks);
  const bhtml=blks.map((b,bi)=>{const col=bcol(bi);const open=!S.mobC[bi];const isSt=b.type==='stations';
    let body='';if(open){
      const info=isSt?`${b.exPerStation||3} exercises ¬∑ ${b.workTime}s each ¬∑ ${b.rounds} rotations ¬∑ ${b.restAfterRound}s rest`:`${b.exercises?.length||0} exercises ¬∑ ${b.rounds} rounds ¬∑ ${b.restAfterRound}s rest`;
      let exs;
      if(S.mobEditMode){
        exs=(b.exercises||[]).map((ex,ei)=>`<div class="mob-ex mob-ex-edit" data-mbi="${bi}" data-mei="${ei}"><span class="mob-exn" style="background:${pcc(ex.cats)}20;color:${pcc(ex.cats)}">${ei+1}</span><span style="font-size:13px;flex:1">${ex.name}</span><span style="font-size:11px;color:var(--amb);font-family:var(--mo)">${ex.duration||b.workTime}s</span><div class="mob-ex-acts"><button data-mswap="${bi}" data-msei="${ei}">üîÑ</button><button class="del" data-mdel="${bi}" data-mdei="${ei}">‚úï</button></div></div>`).join('');
        const addBtn=`<div style="text-align:center;padding:8px"><button data-madd="${bi}" style="padding:6px 16px;border-radius:8px;border:1px dashed var(--bd);background:transparent;color:var(--t3);font-size:12px;cursor:pointer">+ Add Exercise</button></div>`;
        body=`<div class="mob-bb"><div class="mob-bi">${info} ¬∑ ${fmtd(blockDur(b)+(b.restAfterBlock||0))}</div>${exs}${addBtn}</div>`;
      }else{
        exs=(b.exercises||[]).map((ex,ei)=>`<div class="mob-ex"><span class="mob-exn" style="background:${pcc(ex.cats)}20;color:${pcc(ex.cats)}">${ei+1}</span><span style="font-size:13px;flex:1">${ex.name}</span><span style="font-size:11px;color:var(--amb);font-family:var(--mo)">${ex.duration||b.workTime}s</span></div>`).join('');
        body=`<div class="mob-bb"><div class="mob-bi">${info} ¬∑ ${fmtd(blockDur(b)+(b.restAfterBlock||0))}</div>${exs}</div>`;
      }
    }
    return`<div class="mob-b"><div class="mob-bh" data-mt="${bi}"><span class="mob-bn" style="background:${col}20;color:${col}">${bi+1}</span><span class="mob-bt">${b.name}</span><span class="mob-bm">${isSt?'üîÑ':'‚ö°'} ${fmtd(blockDur(b)+(b.restAfterBlock||0))}</span><button class="mob-play" data-mplay="${bi}" title="Start from here">‚ñ∂</button><span style="color:var(--t3)">${open?'‚ñæ':'‚ñ∏'}</span></div>${body}</div>`;
  }).join('');
  const timerBar=S.timerRunning?`<div class="timer-bar" id="tbar"><div class="tb-info"><div class="tb-phase">${S.phase}</div><div class="tb-time">${fmts(S.tL)}</div></div><button class="tb-btn" id="treturn">Return to Timer</button></div>`:'';
  const startBtn=S.timerRunning?'':` <button class="mob-start" id="mstart">‚ñ∂ START</button>`;
  let mdl='';
  if(S.mobEdit)mdl=rSwapModal();
  const editToggle=`<button id="medit" style="padding:6px 14px;border-radius:8px;border:1px solid ${S.mobEditMode?'var(--grn)':'var(--bd)'};background:${S.mobEditMode?'rgba(52,211,153,.12)':'transparent'};color:${S.mobEditMode?'var(--grn)':'var(--t3)'};font-size:12px;font-weight:600;cursor:pointer">${S.mobEditMode?'‚úèÔ∏è Editing':'‚úèÔ∏è Edit'}</button>`;
  return`<div class="mob" style="${S.timerRunning?'padding-bottom:80px':''}"><div class="mob-hd"><div class="tag">Unbreakable Workout</div><div style="display:flex;align-items:center;justify-content:space-between"><h1>Workout Timer</h1>${editToggle}</div></div><div class="mob-s"><div class="mob-sn">${sess.n||S.sName}</div><div class="mob-sm">${blks.length} blocks ¬∑ ${fmtd(td)}</div>${bhtml}</div>${startBtn}${timerBar}</div>${mdl}`;
}
function rSwapModal(){
  const{bi,ei,mode}=S.mobEdit;
  const items=lib.filter(e=>{if(!S.mobEdit.search)return true;return e.name.toLowerCase().includes(S.mobEdit.search.toLowerCase())});
  const grouped={};items.forEach(e=>{const p=e.cats[0]||'other';if(!grouped[p])grouped[p]=[];grouped[p].push(e)});
  let lhtml='';for(const[cat,exs]of Object.entries(grouped)){const C=CATS[cat];lhtml+=`<div class="lcat" style="color:${C?.color||'#666'};padding:8px 0 2px">${C?.label||cat}</div>`;exs.forEach(e=>{lhtml+=`<div class="swap-item" data-swp="${e.name}"><span class="ldot" style="background:${pcc(e.cats)}"></span><span style="flex:1;font-size:13px">${e.name}</span></div>`})}
  const title=mode==='add'?'Add Exercise':'Swap Exercise';
  return`<div class="mbg" id="mbg"><div class="mdl"><h2>${title}</h2><input class="swap-sr" id="msrch" placeholder="Search exercises..." value="${S.mobEdit.search||''}"><div class="swap-list">${lhtml}</div><button class="mc" id="mclose">Cancel</button></div></div>`;
}

// ‚îÄ‚îÄ‚îÄ Timer ‚îÄ‚îÄ‚îÄ
function rTimer(){
  const blks=curBlocks(),b=blks[S.bI],col=bcol(S.bI),isSt=b?.type==='stations';
  const tot=isSt?(b?.exPerStation||3):(b?.exercises?.length||0);
  let accent='#fbbf24',pc='t-rdy';
  if(S.phase==='work'){accent='#34d399';pc='t-wrk'}
  else if(S.phase==='rest'||S.phase==='roundRest'){accent='#60a5fa';pc='t-rst'}
  else if(S.phase==='blockRest'){accent='#fbbf24';pc='t-trn'}
  else if(S.phase==='done'){accent='#e879f9';pc='t-dn'}

  let maxT=5;const ex=b?.exercises?.[S.eI];
  if(S.phase==='work')maxT=isSt?b.workTime:(ex?.duration||b?.workTime||1);
  else if(S.phase==='rest')maxT=b?.restBetween||1;
  else if(S.phase==='roundRest')maxT=b?.restAfterRound||1;
  else if(S.phase==='blockRest')maxT=blks[S.bI-1]?.restAfterBlock||1;
  const prog=maxT>0?1-S.tL/maxT:1;
  const dots=blks.map((_,i)=>`<div class="bdt ${i<S.bI?'dn':''} ${i===S.bI?'act':''}" style="${i===S.bI?`background:${bcol(i)}`:i<S.bI?`background:${bcol(i)}60`:''}"></div>`).join('');
  const sndIcon=S.soundMode==='all'?'üîä':S.soundMode==='end'?'üîî':'üîá';
  const ctrl=`<div class="tctrl"><button class="tb" id="tp">${S.paused?'‚ñ∂':'‚è∏'}</button><button class="tb sk" id="tsk">‚è≠</button><button class="tb" id="tsnd" style="font-size:18px">${sndIcon}</button>${isMob?'<button class="tb" id="tmin" style="font-size:16px">‚úèÔ∏è</button>':''}<button class="tb stp" id="tst">‚ñ†</button></div>`;
  const pov=S.paused?`<div class="pov"><div class="pt">PAUSED</div><button id="tr">‚ñ∂ RESUME</button></div>`:'';

  if(S.phase==='done')return`<div class="timer t-dn"><div class="bdots">${dots}</div><div class="tdn"><div class="emoji">üî•</div><div class="title" style="color:${accent}">DONE!</div><div class="sub">Session complete!</div><button id="tbk">‚Üê Back</button></div></div>`;

  if(S.phase==='blockRest'){
    const nb=blks[S.bI];const nisSt=nb?.type==='stations';
    const ep=nb?.exercises?.slice(0,6).map((e,i)=>`<strong>${i+1}.</strong> ${e.name}`).join('<br>')||'';
    const badge=nisSt?'üîÑ Stations':'‚ö° HIIT';
    const brCd=S.tL<=3&&S.tL>0?(S.tL===1?'countdown-flash cd-1':S.tL<=2?'countdown-flash cd-2':'countdown-flash'):'';
    return`<div class="timer t-trn"><div class="tbar"><div class="tfill" style="width:${prog*100}%;background:${accent}"></div></div><div class="bdots">${dots}</div><div class="trs"><div class="un">Up Next</div><div class="bn" style="color:${bcol(S.bI)}">${nb?.name||''}</div><div style="font-size:12px;color:var(--amb);margin:4px 0">${badge}</div></div><div class="tbig ${brCd}" style="color:${accent};text-shadow:0 0 40px ${accent}30;margin-top:12px">${fmts(S.tL)}</div>${ctrl}${pov}</div>`;
  }

  let phLabel='',exDisp='',hint='',rotInfo='';
  if(isSt){
    phLabel=S.phase==='ready'?'GET READY':S.phase==='work'?'WORK':S.phase==='roundRest'?'ROTATE':'REST';
    if(S.phase==='work')exDisp=`<div class="tex">Exercise ${S.eI+1} of ${tot}</div>`;
    if(S.phase==='work')rotInfo=`<div class="rotinf">Rotation <strong style="color:${accent}">${S.rI+1}</strong> of ${b.rounds}</div>`;
    if(S.phase==='roundRest')hint=`<div class="thint">üîÑ Rotate to next station!</div>`;
  }else{
    phLabel=S.phase==='ready'?'GET READY':S.phase==='roundRest'?'REST':S.phase.toUpperCase();
    if(S.phase==='work'&&ex)exDisp=`<div class="tex">${ex.name}</div>`;
    if(S.phase==='rest'){
      const upNext=b?.exercises?.[S.eI];
      if(upNext)hint=`<div class="thint">Up next: <strong>${upNext.name}</strong></div>`;
    }
    if(S.phase==='roundRest'&&b){
      hint=`<div class="thint">Round ${S.rI+1} ‚Üí <strong>${b.exercises[0]?.name}</strong></div>`;
    }
  }
  const metaI=isSt
    ?`<span>Rotation <strong style="color:${accent}">${S.rI+1}</strong>/${b?.rounds}</span><span>Ex <strong style="color:${accent}">${S.eI+1}</strong>/${tot}</span><span>Block <strong style="color:${accent}">${S.bI+1}</strong>/${blks.length}</span>`
    :`<span>Round <strong style="color:${accent}">${S.rI+1}</strong>/${b?.rounds||0}</span><span>Ex <strong style="color:${accent}">${S.eI+1}</strong>/${tot}</span><span>Block <strong style="color:${accent}">${S.bI+1}</strong>/${blks.length}</span>`;

    const cdClass=S.tL<=3&&S.tL>0?(S.tL===1?'countdown-flash cd-1':S.tL<=2?'countdown-flash cd-2':'countdown-flash'):'';

  return`<div class="timer ${pc}"><div class="tbar"><div class="tfill" style="width:${prog*100}%;background:${accent}"></div></div><div class="bdots">${dots}</div>
    <div class="tblk" style="color:${col}">${b?.name||''}</div><div class="tph" style="color:${accent}">${phLabel}</div>
    ${exDisp}${rotInfo}
    <div class="tbig ${cdClass}" style="color:${accent};text-shadow:0 0 50px ${accent}30">${fmts(S.tL)}</div>
    <div class="ttrk"><div class="ttf" style="width:${prog*100}%;background:${accent}"></div></div>
    <div class="tmeta">${metaI}</div>${hint}${ctrl}${pov}</div>`;
}

// ‚ïê‚ïê‚ïê Bind ‚ïê‚ïê‚ïê
const ssC={nPeople:{min:1,max:40,step:1}};
const bsC={workTime:{min:5,max:120,step:5},restBetween:{min:0,max:60,step:5},restAfterRound:{min:0,max:120,step:5},restAfterBlock:{min:0,max:120,step:5},rounds:{min:1,max:20,step:1},exPerStation:{min:1,max:10,step:1}};

function bBuilder(){
  document.querySelectorAll('[data-bs]').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();const k=b.dataset.bs,bi=+b.dataset.bi,d=+b.dataset.d,c=bsC[k];S.blocks[bi][k]=Math.max(c.min,Math.min(c.max,(S.blocks[bi][k]||0)+d*c.step));render()}));
  document.querySelectorAll('[data-bn]').forEach(i=>{i.addEventListener('change',()=>{S.blocks[+i.dataset.bn].name=i.value});i.addEventListener('click',e=>e.stopPropagation())});
  document.getElementById('sn')?.addEventListener('change',e=>{S.sName=e.target.value});
  document.querySelectorAll('[data-tt]').forEach(b=>b.addEventListener('click',()=>{S.targetTime=Math.max(5,Math.min(120,S.targetTime+(+b.dataset.tt)*5));render()}));
  document.querySelectorAll('[data-bt]').forEach(b=>b.addEventListener('click',()=>{S.blocks[+b.dataset.bt].type=b.dataset.v;render()}));
  document.querySelectorAll('[data-mv]').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();const i=+b.dataset.mv,n=i+(+b.dataset.d);if(n<0||n>=S.blocks.length)return;[S.blocks[i],S.blocks[n]]=[S.blocks[n],S.blocks[i]];render()}));
  document.querySelectorAll('[data-db]').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();if(S.blocks.length<=1)return;S.blocks.splice(+b.dataset.db,1);render()}));
  document.querySelectorAll('[data-cloneb]').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();const bi=+b.dataset.cloneb;const clone=JSON.parse(JSON.stringify(S.blocks[bi]));clone.id=uid();clone.name=clone.name+' (copy)';S.blocks.splice(bi+1,0,clone);render()}));
  document.getElementById('btn-ab')?.addEventListener('click',()=>{S.blocks.push(newBlock(S.blocks.length));render()});
  document.getElementById('btn-start')?.addEventListener('click',()=>{S.mobSession=null;startTimer()});
  // Per-exercise duration
  document.querySelectorAll('[data-ed]').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();const bi=+b.dataset.ed,ei=+b.dataset.ee,d=+b.dataset.d;const ex=S.blocks[bi].exercises[ei];if(!ex.duration)ex.duration=S.blocks[bi].workTime;ex.duration=Math.max(5,Math.min(120,ex.duration+d*5));render()}));
  // Exercise actions
  document.querySelectorAll('[data-act]').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();const bi=+b.dataset.bi,ei=+b.dataset.ei;if(b.dataset.act==='dup'){const ex=S.blocks[bi].exercises[ei];S.blocks[bi].exercises.splice(ei+1,0,{...ex});render()}else if(b.dataset.act==='del'){S.blocks[bi].exercises.splice(ei,1);render()}else if(b.dataset.act==='note'){S.noteBI=bi;S.noteEI=ei;S.modal='note';render()}}));
  // Library
  document.getElementById('lsr')?.addEventListener('input',e=>{S.libSearch=e.target.value;
    // Only update library list, not whole page, to keep focus
    const items=filtLib();const grouped={};
    items.forEach(ex=>{const p=ex.cats[0]||'other';if(!grouped[p])grouped[p]=[];grouped[p].push(ex)});
    let lh='';for(const[cat,exs]of Object.entries(grouped)){const C=CATS[cat];lh+=`<div class="lcat" style="color:${C?.color||'#666'}">${C?.label||cat}</div>`;exs.forEach(ex=>{const tags=ex.cats.map(c=>ctag(c)).join('');lh+=`<div class="li" draggable="true" data-lib="${ex.name}"><span class="ldot" style="background:${pcc(ex.cats)}"></span><span style="flex:1">${ex.name}</span>${tags}<button class="li-x" data-ldel="${ex.name}">‚úï</button></div>`})}
    const ll=document.getElementById('lls');if(ll)ll.innerHTML=lh;
    // Rebind lib drag and delete on new items
    document.querySelectorAll('.li[draggable]').forEach(item=>{
      item.addEventListener('dragstart',ev=>{drag={type:'lib',data:item.dataset.lib};item.classList.add('dragging');ev.dataTransfer.effectAllowed='copy';ev.dataTransfer.setData('text/plain','')});
      item.addEventListener('dragend',()=>{drag={type:null,data:null};item.classList.remove('dragging');document.querySelectorAll('.bcol').forEach(el=>el.classList.remove('dov'));document.querySelectorAll('.bexs').forEach(el=>el.classList.remove('dt'))});
    });
    document.querySelectorAll('[data-ldel]').forEach(b=>b.addEventListener('click',ev=>{ev.stopPropagation();ev.preventDefault();const dn=b.dataset.ldel;lib=lib.filter(l=>l.name!==dn);if(!libDel.includes(dn))libDel.push(dn);saveLib();render()}));
  });
  document.querySelectorAll('.lf').forEach(b=>b.addEventListener('click',()=>{S.libFilter=b.dataset.c;render()}));
  document.getElementById('btn-ce')?.addEventListener('click',()=>{S.modal='customEx';S.ceData={name:'',cats:[],note:''};render()});
  document.querySelectorAll('[data-ldel]').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();e.preventDefault();const dn=b.dataset.ldel;lib=lib.filter(l=>l.name!==dn);if(!libDel.includes(dn))libDel.push(dn);saveLib();render()}));
  // Top buttons
  document.getElementById('btn-tpl')?.addEventListener('click',()=>{S.modal='templates';render()});
  document.getElementById('btn-save')?.addEventListener('click',()=>{tpls.push({name:S.sName,blocks:JSON.parse(JSON.stringify(S.blocks))});saveTpls();saveSession();S.modal='templates';render()});
  document.getElementById('btn-share')?.addEventListener('click',()=>{saveSession();S.modal='share';render()});

  // Lib drag
  document.querySelectorAll('.li[draggable]').forEach(item=>{
    item.addEventListener('dragstart',e=>{drag={type:'lib',data:item.dataset.lib};item.classList.add('dragging');e.dataTransfer.effectAllowed='copy';e.dataTransfer.setData('text/plain','')});
    item.addEventListener('dragend',()=>{drag={type:null,data:null};item.classList.remove('dragging');document.querySelectorAll('.bcol').forEach(el=>el.classList.remove('dov'));document.querySelectorAll('.bexs').forEach(el=>el.classList.remove('dt'))});
  });
  document.querySelectorAll('.bexs,.dz').forEach(z=>{const bi=+z.dataset.dbi;
    z.addEventListener('dragover',e=>{e.preventDefault();if(drag.type==='lib'){z.classList.add('dt');document.querySelector(`[data-bci="${bi}"]`)?.classList.add('dov')}});
    z.addEventListener('dragleave',()=>{z.classList.remove('dt');document.querySelector(`[data-bci="${bi}"]`)?.classList.remove('dov')});
    z.addEventListener('drop',e=>{e.preventDefault();z.classList.remove('dt');document.querySelector(`[data-bci="${bi}"]`)?.classList.remove('dov');if(drag.type==='lib'){const le=lib.find(l=>l.name===drag.data);S.blocks[bi].exercises.push({name:drag.data,cats:le?.cats||[],note:le?.note||'',duration:S.blocks[bi].workTime});drag={type:null,data:null};render()}});
  });
  // Reorder
  document.querySelectorAll('.bex[draggable]').forEach(item=>{
    item.addEventListener('dragstart',e=>{drag={type:'ro',data:{bi:+item.dataset.bi,ei:+item.dataset.ei}};item.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain','')});
    item.addEventListener('dragend',()=>{drag={type:null,data:null};document.querySelectorAll('.bex').forEach(el=>el.classList.remove('dragging','dov-ex'))});
    item.addEventListener('dragover',e=>{e.preventDefault();if(drag.type==='ro'&&drag.data.bi===+item.dataset.bi&&drag.data.ei!==+item.dataset.ei){document.querySelectorAll('.bex').forEach(el=>el.classList.remove('dov-ex'));item.classList.add('dov-ex')}if(drag.type==='lib'){document.querySelectorAll('.bex').forEach(el=>el.classList.remove('dov-ex'));item.classList.add('dov-ex')}});
    item.addEventListener('drop',e=>{e.preventDefault();item.classList.remove('dov-ex');const tbi=+item.dataset.bi,tei=+item.dataset.ei;if(drag.type==='ro'&&drag.data.bi===tbi){const a=S.blocks[tbi].exercises,m=a.splice(drag.data.ei,1)[0];a.splice(tei,0,m);render()}if(drag.type==='lib'){const le=lib.find(l=>l.name===drag.data);S.blocks[tbi].exercises.splice(tei,0,{name:drag.data,cats:le?.cats||[],note:le?.note||'',duration:S.blocks[tbi].workTime});drag={type:null,data:null};render()}});
  });
  bModals();
}

function bModals(){
  document.getElementById('mbg')?.addEventListener('click',e=>{if(e.target.id==='mbg'){S.modal=null;render()}});
  document.getElementById('mclose')?.addEventListener('click',()=>{S.modal=null;render()});
  document.querySelectorAll('[data-tl]').forEach(b=>b.addEventListener('click',()=>{const t=tpls[+b.dataset.tl];S.sName=t.name;S.blocks=JSON.parse(JSON.stringify(t.blocks));S.modal=null;render()}));
  document.querySelectorAll('[data-td]').forEach(b=>b.addEventListener('click',()=>{tpls.splice(+b.dataset.td,1);saveTpls();render()}));
  document.querySelectorAll('[data-cc]').forEach(b=>b.addEventListener('click',()=>{const c=b.dataset.cc;if(S.ceData.cats.includes(c))S.ceData.cats=S.ceData.cats.filter(x=>x!==c);else S.ceData.cats.push(c);render()}));
  document.getElementById('cen')?.addEventListener('input',e=>{S.ceData.name=e.target.value});
  document.getElementById('cent')?.addEventListener('input',e=>{S.ceData.note=e.target.value});
  document.getElementById('cec')?.addEventListener('click',()=>{S.modal=null;render()});
  document.getElementById('ces')?.addEventListener('click',()=>{if(!S.ceData.name.trim())return;lib.push({name:S.ceData.name.trim(),cats:S.ceData.cats.length?S.ceData.cats:['resistance'],note:S.ceData.note||''});saveLib();S.modal=null;render()});
  document.getElementById('nc')?.addEventListener('click',()=>{S.modal=null;render()});
  document.getElementById('ns')?.addEventListener('click',()=>{const v=document.getElementById('ntext')?.value||'';if(S.blocks[S.noteBI]?.exercises[S.noteEI])S.blocks[S.noteBI].exercises[S.noteEI].note=v;S.modal=null;render()});
  document.getElementById('cpurl')?.addEventListener('click',()=>{navigator.clipboard.writeText(location.origin).then(()=>{document.getElementById('cpurl').textContent='‚úì Copied!'});setTimeout(()=>{const b=document.getElementById('cpurl');if(b)b.textContent='üìã Copy Site URL'},2e3)});
  document.getElementById('cpurl2')?.addEventListener('click',()=>{const u=document.getElementById('surl')?.textContent;if(u){navigator.clipboard.writeText(u).then(()=>{document.getElementById('cpurl2').textContent='‚úì Copied!'});setTimeout(()=>{const b=document.getElementById('cpurl2');if(b)b.textContent='üìã Copy Workout URL'},2e3)}});
  // QR handled by img tag in modal
}

function startFromBlock(bi){
  const blks=curBlocks();
  if(bi>=blks.length)return;
  ga();S.screen='timer';S.bI=bi;S.eI=0;S.rI=0;S.paused=false;S.phase='ready';S.tL=5;S.timerRunning=true;
  clearInterval(tInt);tInt=setInterval(tick,1e3);
  try{navigator.wakeLock?.request('screen')}catch(e){}render();
}

function bMobile(){
  // Block collapse/expand (only if not clicking play button)
  document.querySelectorAll('[data-mt]').forEach(b=>b.addEventListener('click',(e)=>{
    if(e.target.closest('[data-mplay]')||e.target.closest('[data-mswap]')||e.target.closest('[data-mdel]')||e.target.closest('[data-madd]'))return;
    S.mobC[+b.dataset.mt]=!S.mobC[+b.dataset.mt];render();
  }));
  document.getElementById('mstart')?.addEventListener('click',()=>{S.mobSession=S.mobSession||{blocks:S.blocks};startTimer()});
  document.getElementById('medit')?.addEventListener('click',()=>{S.mobEditMode=!S.mobEditMode;render()});
  document.getElementById('mload')?.addEventListener('click',()=>{try{const d=JSON.parse(document.getElementById('mpaste')?.value);if(d.blocks){S.mobSession=d;S.blocks=d.blocks;S.sName=d.n||'Session';render()}}catch(e){alert('Invalid data')}});
  // Start from block
  document.querySelectorAll('[data-mplay]').forEach(b=>b.addEventListener('click',(e)=>{e.stopPropagation();const bi=+b.dataset.mplay;S.mobSession=S.mobSession||{blocks:S.blocks};startFromBlock(bi)}));
  // Swap exercise
  document.querySelectorAll('[data-mswap]').forEach(b=>b.addEventListener('click',(e)=>{e.stopPropagation();S.mobEdit={bi:+b.dataset.mswap,ei:+b.dataset.msei,mode:'swap',search:''};render()}));
  // Delete exercise
  document.querySelectorAll('[data-mdel]').forEach(b=>b.addEventListener('click',(e)=>{e.stopPropagation();const bi=+b.dataset.mdel,ei=+b.dataset.mdei;const blks=S.mobSession?.blocks||S.blocks;blks[bi].exercises.splice(ei,1);render()}));
  // Add exercise
  document.querySelectorAll('[data-madd]').forEach(b=>b.addEventListener('click',(e)=>{e.stopPropagation();S.mobEdit={bi:+b.dataset.madd,ei:-1,mode:'add',search:''};render()}));
  // Return to timer bar
  document.getElementById('treturn')?.addEventListener('click',returnToT);
  document.getElementById('tbar')?.addEventListener('click',(e)=>{if(e.target.id!=='treturn')returnToT()});
  // Swap modal bindings
  document.getElementById('mclose')?.addEventListener('click',()=>{S.mobEdit=null;render()});
  document.getElementById('mbg')?.addEventListener('click',(e)=>{if(e.target.id==='mbg'){S.mobEdit=null;render()}});
  document.getElementById('msrch')?.addEventListener('input',(e)=>{if(S.mobEdit)S.mobEdit.search=e.target.value;
    // Partial re-render of swap list only
    const ml=document.querySelector('.swap-list');if(ml){
      const items=lib.filter(ex=>{if(!S.mobEdit.search)return true;return ex.name.toLowerCase().includes(S.mobEdit.search.toLowerCase())});
      const grouped={};items.forEach(ex=>{const p=ex.cats[0]||'other';if(!grouped[p])grouped[p]=[];grouped[p].push(ex)});
      let h='';for(const[cat,exs]of Object.entries(grouped)){const C=CATS[cat];h+=`<div class="lcat" style="color:${C?.color||'#666'};padding:8px 0 2px">${C?.label||cat}</div>`;exs.forEach(ex=>{h+=`<div class="swap-item" data-swp="${ex.name}"><span class="ldot" style="background:${pcc(ex.cats)}"></span><span style="flex:1;font-size:13px">${ex.name}</span></div>`})}
      ml.innerHTML=h;
      ml.querySelectorAll('[data-swp]').forEach(s=>s.addEventListener('click',()=>doSwap(s.dataset.swp)));
    }
  });
  document.querySelectorAll('[data-swp]').forEach(s=>s.addEventListener('click',()=>doSwap(s.dataset.swp)));
}
function doSwap(name){
  if(!S.mobEdit)return;
  const{bi,ei,mode}=S.mobEdit;
  const blks=S.mobSession?.blocks||S.blocks;
  const le=lib.find(l=>l.name===name);
  const newEx={name,cats:le?.cats||['other'],note:'',duration:0};
  if(mode==='swap'&&ei>=0){
    newEx.duration=blks[bi].exercises[ei].duration||0;
    blks[bi].exercises[ei]=newEx;
  }else{
    blks[bi].exercises.push(newEx);
  }
  S.mobEdit=null;render();
}

function bTimer(){
  document.getElementById('tp')?.addEventListener('click',togPause);
  document.getElementById('tst')?.addEventListener('click',stopT);
  document.getElementById('tr')?.addEventListener('click',togPause);
  document.getElementById('tbk')?.addEventListener('click',stopT);
  document.getElementById('tsk')?.addEventListener('click',skip);
  document.getElementById('tmin')?.addEventListener('click',minimizeT);
  document.getElementById('tsnd')?.addEventListener('click',()=>{
    const modes=['all','end','mute'];
    S.soundMode=modes[(modes.indexOf(S.soundMode)+1)%modes.length];
    render();
  });
}

render();
loadFromServer();
</script>
</body>
</html>
